name: Criar Sub-Issues a partir de Epic

on:
  issues:
    types: [opened]

jobs:
  create-subissues:
    runs-on: ubuntu-latest
    steps:
      - name: Criar sub-issues e infraestrutura
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const issue = context.payload.issue;
            const body = issue.body;
            const parentNumber = issue.number;
            const owner = context.repo.owner;

            // Fun莽茫o auxiliar para extrair se莽玫es
            const extract = (label) => {
              const match = body.match(new RegExp(`### ${label}[\\s\\S]*?\\n(.*?)\\n`, 'i'));
              return match ? match[1].trim() : null;
            };

            // Extrair nome do reposit贸rio
            const repoName = extract('Nome do reposit贸rio');
            const projectTitle = `${repoName} - Planejamento`;

            // Verifica se o reposit贸rio existe
            let repoExists = false;
            try {
              await github.rest.repos.get({ owner, repo: repoName });
              repoExists = true;
            } catch (error) {
              repoExists = false;
            }

            // Cria o reposit贸rio se necess谩rio
            if (!repoExists) {
              await github.rest.repos.createInOrg({
                org: owner,
                name: repoName,
                private: true,
                auto_init: true,
                description: `Reposit贸rio criado automaticamente para a Epic #${parentNumber}`
              });
            }

            // Busca o ID do reposit贸rio via GraphQL
            const repoQuery = await github.graphql(`
              query($owner: String!, $name: String!) {
                repository(owner: $owner, name: $name) {
                  id
                }
              }
            `, { owner, name: repoName });

            const repoId = repoQuery.repository.id;

            // Cria o Project v2 vinculado ao reposit贸rio
            const projectMutation = await github.graphql(`
              mutation($repoId:ID!, $title:String!) {
                createProjectV2(input: {ownerId: $repoId, title: $title}) {
                  projectV2 {
                    id
                    title
                    url
                  }
                }
              }
            `, { repoId, title: projectTitle });

            const projectUrl = projectMutation.createProjectV2.projectV2.url;

            // Determinar tipo da issue
            let tipo = 'Task';
            if (issue.title.includes('[Epic]')) tipo = 'Feature';
            else if (issue.title.includes('[Feature]')) tipo = 'Task';

            // Extrair subissues
            const subissuesRaw = body.split('### Sub-issues a serem criadas')[1];
            const subissues = subissuesRaw ? subissuesRaw.split('\n').map(l => l.trim()).filter(l => l.length > 0) : [];

            // Extrair labels adicionais
            const labels = [tipo.toLowerCase(), ...extract('Labels adicionais')?.split(',').map(l => l.trim()).filter(Boolean) || []];

            // Buscar milestone apenas se for Task
            let milestoneId = null;
            if (tipo === 'Task') {
              const sprintName = extract('Sprint ou per铆odo de execu莽茫o');
              if (sprintName) {
                const milestones = await github.rest.issues.listMilestones({
                  owner,
                  repo: context.repo.repo
                });
                const found = milestones.data.find(m => m.title === sprintName);
                if (found) milestoneId = found.number;
              }
            }

            const createdIssues = [];

            for (const line of subissues) {
              const issuePayload = {
                owner,
                repo: context.repo.repo,
                title: `[${tipo}] ${line}`,
                body: `Sub-issue de #${parentNumber}`,
                labels
              };

              if (tipo === 'Task' && milestoneId) {
                issuePayload.milestone = milestoneId;
              }

              const newIssue = await github.rest.issues.create(issuePayload);
              createdIssues.push(`- [ ] #${newIssue.data.number} ${line}`);
            }

            // Atualizar issue original com checklist e link do projeto
            const checklist = `### Sub-issues criadas automaticamente\n${createdIssues.join('\n')}\n\n Projeto vinculado: [${projectTitle}](${projectUrl})`;
            await github.rest.issues.update({
              owner,
              repo: context.repo.repo,
              issue_number: parentNumber,
              body: body + '\n\n' + checklist
            });

